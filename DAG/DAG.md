# DAG 

基于DAG的分布式账本中, 每个账本的基本单元可以引用一至多个前驱单元, 且可以被一个或多个后继单元同时引用。这种基于DAG的账本操作支持并发进行, 多个节点可以同时向账本中新增交易或区块单元, 从而极大地提高了系统吞吐量。

以太坊这这样的智能合约公链，顺序性一次执行一个交易，所有其他的交易置于暂停状态，直到前面交易执行完成，再顺序执行后面交易。基于 DAG 的交易分析交易之间的依赖性，无依赖关系的交易之间并行执行，充分发挥硬件的并行特性，提升网路吞吐量，有效改进了交易确认的延迟。

## DAG 并行区块区块链发展现状

DAG 发展现状：[基于 DAG 的分布式账本共识机制研究](https://www.jos.org.cn/jos/article/pdf/5982)。

在 DAG 拓扑中共识出一条主干链，随后基于此对 DAG 进行拓扑排序。

将主链之外的其他区块也包含进最终的 DAG 账本中,从而更大程度地提高了账本的吞吐量和并发条件下的性能。

但是要能在同一个区块高度同时产生多个区块，现有安全可靠的共识算法是 POW。 POW 不一定适合 TURN 网络。

### GHOST

GHOST 协议，采用“最大权重子树”原则来选取主链,以取代比特币中的最长链原则。

先计算以每个候选子区块为树根的子树权重大小,取权重最大者为下一个主链区块.如此不断递归,直至到达 T 的端节点。

GHOST 证明,即使在出块速率较高的网络中,颠覆主链所需的恶意节点临界算力依旧为 50%。

GHOST 在树形 DAG 的基础上通过最大权重子树递归地选举主链,提高了系统在并发情况下的安全性.但与比特币一样,GHOST 账本不包含主链之外区块(孤块)中的交易.这一方面造成系统算力的浪费,另一方面,系统性能也不能随着系统节点(算力)的增加而呈线性提高。

### Inclusive Blockchain Protocol

Inclusive 协议中,每个区块可以同时引用若干个父区块，DAG 中的所有区块均被视为最终账本的一部分。

Inclusive 协议首先在 DAG中共识主链,然后根据主链和拓扑结构对所有区块排序.区块全序确定之后,根据交易所在区块的顺序,冲突交易中优先被区块包含的被判定合法,其他视为非法,最终,所有的合法交易构成账本交易集合。

Inclusive 协议在共识主链的过程中可以采用比特币的最长链原则也可以利用 GHOST 协议最大权重子树。

问题一，主链之外的区块也能获得挖矿及手续费奖励，容易导致双花攻击失败,攻击者也能获得奖励,双花攻击的代价因此减小。Inclusive 协议引入了奖励递减函数,非主链区块的奖励与它们被主链区块引用的速度有关,引用越“慢”,奖励越低。

另一个问题是,如果矿工在利益驱使下,均优先包含高手续费的交易,那么区块之间的交易重复率将大大增加,导致系统吞吐量并不能随着区块的增加而呈线性提高。解决方法矿工在产生区块时会随机选取交易进行包含,以避免因冲突而带来的交易费的损失,从而使得自己的收益最大化。

### Conflux

Conflux 中,每个区块有且只有一个父节点边(parent edge),代表一种投票关系,用于共识主链.除此之外,对其他所有前驱区块的引用均为引用边(reference edge),仅用于判定时间先后顺序。

Conflux 采用 GHOST 的最大权重子树原则递归地从这棵树中选举主链.主链确定后,利用主链区块将 DAG 划分为前后相继的轮次,分别对每轮内的所有区块运行拓扑排序算法,最终构成整个 DAG 的区块全序,进而交易全序及冲突交易的合法性也被确定.与主链共识算法相对应地,每个节点在产生新区块时会用父节点边引用视图中的主链端区块(入度为 0 的区块),如同比特币中矿工延长最长链一样,起到主链投票的作用;而主链端区块之外的所有其他端区块,均采用引用边进行引用,以促使 DAG 收敛并用于拓扑排序。

[conflux 算法细节](https://arxiv.org/pdf/1805.03870.pdf) 

## DAG 并行交易

有些协议使用基于DAG 的帐本，而有些则只在交易处理中部分使用DAG，区分这两类协议非常重要，因为后者（只使用部分DAG）不可会获得前者同等的交易流通量提升。

参考文章 ，[DAG 架构设计](https://www.blocktempo.com/amber-group-demystifying-the-landscape-of-dag-based-architecture/) 

### sui

Sui 的交易处理架构可以视作两部分：一部分是全序且依序执行的依赖交易，另一部分是因果序且平行执行的独立交易。

大多数分散式帐本都以地址为中心，而Sui 的帐本则以「物件（object）」为中心，物件可以是NFT、dapp、代币，或者基本上你可以在传统区块链上构建为智能合约的任何东西。

Sui 的帐本是一个「物件储存库」或「物件池」，其数据储存在DAG 中。在这个DAG 中，节点是物件，而图中的每个箭头代表一个交易，该交易更新给定物件的属性。

共享物件的交易必须是全序的，因为任何用户的交易都会更改他们正在互动的物件，因此交易的先后顺序很重要。

Sui 的智能合约语言Move 支持将物件进行分类以及平行执行Sui 的交易，如果没有Move，Sui 的智能合约架构可能无法实现

## 延伸阅读

[DAG 区块链中基于确定性退火技术的融合分割遗传任务调度算法](http://scis.scichina.com/cn/2020/N112019-00025.pdf) 

[基于ＤＡＧ的区块链新模型设计与](http://www.shcas.net/jsjyup/pdf/2021/10/%E5%9F%BA%E4%BA%8EDAG%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E6%96%B0%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0.pdf) 




